image: php:7.3-alpine

cache:
  paths:
    - vendor/
    - var/cache

variables:
  APP_ENV: "prod"
  APP_DEBUG: "0"
  COMPOSER_MEMORY_LIMIT: "-1"

stages:
  - build
  - test
  - upload

build:
  stage: build
  artifacts:
    paths:
      - vendor/
      - node_modules/
  before_script:
    - apk add composer yarn
  script:
    - php -v
    - php -r "echo ini_get('memory_limit').PHP_EOL;"
    - echo $COMPOSER_MEMORY_LIMIT
    - composer install --no-dev --optimize-autoloader --no-interaction --no-plugins --no-scripts --no-suggest
    - yarn install --no-dev
    - yarn encore prod

upload:
  stage: upload
  before_script:
    - apk add lftp
  script:
    - rm -rf .git/*
    - lftp -c "set ftp:ssl-allow no; set ftp:list-options -a; open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST; ls; mirror -c --verbose -Re -P 10 ./ $FTP_PATH --exclude-glob-from .ftpignore"